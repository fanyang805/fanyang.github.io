<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Fan's site | Online SLAM with Extended Kalman Filter</title>
<meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design.
">

<!-- Open Graph -->


<!-- Bootstrap & MDB -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" integrity="sha512-RO38pBRxYH3SoOprtPTD86JFOclM51/XTIdEPh5j8sj4tp8jmQIx26twG52UaLi//hQldfrh7e51WzP9wuP32Q==" crossorigin="anonymous" />

<!-- Fonts & Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"  integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.0/css/academicons.min.css" integrity="sha512-W4yqoT1+8NLkinBLBZko+dFB2ZbHsYLDdr50VElllRcNt2Q4/GSs6u71UHKxB7S6JEMCp5Ve4xjh3eGQl/HRvg==" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

<!-- Code Syntax Highlighting -->
<link rel="stylesheet" href="https://gitcdn.link/repo/jwarby/jekyll-pygments-themes/master/github.css" />

<!-- Styles -->
<!-- 
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22></text></svg>">
 -->
<!-- <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22></text></svg>"> -->
<link rel="shortcut icon" href="/assets/img/favicon.ico">
<link rel="stylesheet" href="/assets/css/main.css">

<link rel="canonical" href="/projects/SLAM/EKF-slam/">

<!-- JQuery -->
<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>


<!-- Theming-->

  <script src="/assets/js/theme.js"></script>
  <!-- Load DarkMode JS -->
<script src="/assets/js/dark_mode.js"></script>






    
<!-- MathJax -->
<script type="text/javascript">
  window.MathJax = {
    tex: {
      tags: 'ams'
    }
  };
</script>
<script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js"></script>
<script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>


  </head>

  <body class="fixed-top-nav sticky-bottom-footer">

    <!-- Header -->

    <header>

    <!-- Nav Bar -->
    <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
    <div class="container">
      
      <a class="navbar-brand title font-weight-lighter" href="/">
        <i class="fas fa-fan fa-spin"></i>
       Fan's site
      </a>
      
      <!-- Navbar Toggle -->
      <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar top-bar"></span>
        <span class="icon-bar middle-bar"></span>
        <span class="icon-bar bottom-bar"></span>
      </button>
      <div class="collapse navbar-collapse text-right" id="navbarNav">
        <ul class="navbar-nav ml-auto flex-nowrap">
          <!-- About -->
          <li class="nav-item ">
            <a class="nav-link" href="/">
              About
              
            </a>
          </li>
          
          <!-- Blog -->
          <li class="nav-item ">
            <a class="nav-link" href="/blog/">
              Blog 
              
            </a>
          </li>
          
          <!-- Other pages -->
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/course-work/">
                Course Work
                
              </a>
          </li>
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/projects/">
                Projects
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/publications/">
                Publications
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/research/">
                Research
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/services/">
                Services
                
              </a>
          </li>
          
          
          
          
          
            <div class = "toggle-container">
              <a id = "light-toggle">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
              </a>
            </div>
          
        </ul>
      </div>
    </div>
  </nav>

</header>


    <!-- Content -->

    <div class="container mt-5">
      <div class="post">

  <header class="post-header">
    <h1 class="post-title">Online SLAM with Extended Kalman Filter</h1>
    <!-- <p class="post-description">The first SLAM solution in history is based on the Extended Kalman Filter. This project implements an EKF SLAM system. Given the sensor readings and odometry information, the robot computes a feature-based map while simultaneously localizing itself.
</p> -->
  </header>

  <article>
    <p>The SLAM problem is one of the most fundamental problems in robotics. SLAM problems arise when both map of the environment and the pose of robot are not available. Robots are only given the measurement \(z_{1:t}\) and controls \(u_{1:t}\). In SLAM problem, the robot should learn a map of the environment and simultaneously estimate its pose in the environment.</p>

<p>There are two main forms of SLAM problem:</p>

<ol>
  <li>
    <p>Full SLAM problem: robot should computes a posterior over the entire path along with the map, i.e., 
\(P(x_{1:t}, m|z_{1:t},u_{1:t})\).</p>
  </li>
  <li>
    <p>Online SLAM problem: robot computes a posterior over the pose in the current time step along with the map, i.e., 
\(P(x_t, m|z_{1:t},u_{1:t})\).</p>
  </li>
</ol>

<p>In this project, we implement the EKF SLAM algorithm for the online SLAM problem. The map in this problem is the feature-based map, which is composed of point landmarks. The data set<sup>[1]</sup> contains the odometry information, the range-bearing sensor readings and the correspondence in each time step. Using EKF, the robot estimates the current pose of robot (illustrated by the red covariance ellipse and bar) and the positions of all landmarks (illustrated by the blue covariance ellipse). The gray lines show the observed landmarks in the current time step.</p>
<div class="row justify-content-center">
      <div class="col">
        <div class="w-50 mx-auto" style="background-color: white;">
            <img class="img-fluid" src="/projects/SLAM/EKF-slam/assets/img/ekf_slam.gif" alt="" />
        </div>
      </div>
  </div>
<div class="caption">
  Extended Kalman Filter Algorithm for the Online SLAM Problem
  </div>

<h2 id="ekf-overview">EKF Overview</h2>

<p>Similar to EKF for localization, the algorithm include two steps: predication by the motion model and correction by the sensor model. Unlike EKF for localization problem, the state includes the position of all landmarks in addition to the robotâ€™s pose, i.e.,
\((x,y,\theta, m_{1,x}, m_{1,y}, ..., m_{n,x}, m_{n,y})\) where \(n\) is the number of landmarks.</p>

<p>Therefore the nonlinear motion function \(g(u_t, x_{t-1})\), obvervation function \(h(x_t)\), and the corresponding Jacobian \(G_t\) and \(H_t\) should be changed accordingly.</p>

<div class="row justify-content-center">
    <div class="col">
        <div class="w-50 mx-auto" style="background-color: white;">
            <img class="img-fluid" src="/projects/localization/EKF/assets/img/extended-kalman-filter.png" alt="" />
        </div>
    </div>
</div>
<div class="caption">
The Extended Kalman Filter for Localization
</div>
<p><br /></p>

<p>More specifically for the odometry motion model, the prediction step is</p>

\[\bar{\mu}_t = g(u_t, \mu_{t-1})  = \mu_{t-1} + F^T_{x}
    \begin{bmatrix}
        \delta_{tran} \cos(\mu_{\theta_{t-1,\theta}}+\delta_{rot1}) \\
        \delta_{tran} \sin(\mu_{\theta_{t-1,\theta}}+\delta_{rot1})  \\
        \delta_{rot1}+ \delta_{rot2} 
    \end{bmatrix}\]

<p>where \(\mu_{t-1}\in \mathbb{R}^{(3+2n)\times 1}, F_x \in \mathbb{R}^{3\times (3+2n)}\)</p>

\[\mu_{t-1} = 
    \begin{bmatrix}
    \mu_{t-1, x} \\
    \mu_{t-1, y} \\
    \mu_{t-1, \theta} \\
    \mu_{m_1,x} \\
    \vdots \\
    \mu_{m_n,y}
    \end{bmatrix},
     \ \ F_x = 
    \begin{bmatrix}
    1 &amp; 0 &amp; 0 &amp; \cdots &amp; 0 \\
    0 &amp; 1 &amp; 0 &amp; \cdots &amp; 0 \\
    0 &amp; 0 &amp; 1 &amp; \cdots &amp; 0 \\
    \end{bmatrix}\]

<p>Note that the estimate of positions of landmarks do not change due to the control.</p>

<p>The Jacobian of \(g(u_t, x_{t-1})\) with respect to \(x_{t-1}\) at \(\mu_{t-1}\) is</p>

\[G_t = 
\begin{bmatrix}
G_t^x &amp; 0 \\
0 &amp; I_{2n\times 2n}
\end{bmatrix}, \ \
G_t^x = 
\begin{bmatrix}
    1 &amp; 0 &amp; -\delta_{tran} \sin(\mu_{\theta_{t-1}}+\delta_{rot1}) \\
    0 &amp; 1 &amp; \delta_{tran} \cos(\mu_{\theta_{t-1}}+\delta_{rot1})  \\
    0 &amp; 0 &amp; 1 
\end{bmatrix}\]

<p>For the range-bearing sensor model, consider the range-bearing sensor model for each landmark \(i\) (which returns the expected sensor reading),</p>

\[\hat{z}_t^i = h^i(\bar{\mu}_t) = 
\begin{bmatrix}
\sqrt{q} \\
\mathrm{atan2}(\delta_y, \delta_x) - \bar{\mu}_{t,\theta}
\end{bmatrix}\]

<p>where 
\(\delta = 
\begin{bmatrix}
    \delta_x \\
    \delta_y
\end{bmatrix} = 
\begin{bmatrix}
\bar{\mu}_{m_j,x} - \bar{\mu}_{t,x} \\
\bar{\mu}_{m_j,y} - \bar{\mu}_{t,y} 
\end{bmatrix},
q = \delta^T \delta\)
and \(j\) is the correspondence of the measurement \(i\).</p>

<p>The Jacobian of \(h^i(x_t)\) at \(\bar{\mu}_t\) is</p>

\[H_t^i = \frac{1}{q} 
\begin{bmatrix}
-\sqrt{q} \delta_x &amp; -\sqrt{q} \delta_x &amp; 0 &amp; \sqrt{q} \delta_x &amp; \sqrt{q} \delta_y \\
\delta_y &amp; -\delta_x &amp; -q &amp; -\delta_y &amp; \delta_x
\end{bmatrix}
F_{x,j}, \  
H_t^i \in \mathbb{R}^{2\times (3+2n)}\]

<p>where
\(F_{x,j} = 
\begin{bmatrix}
1 &amp; 0 &amp; 0 &amp; 0 &amp; \cdots &amp; 0 &amp; 0 &amp; \cdots &amp; 0 \\
0 &amp; 1 &amp; 0 &amp; 0 &amp; \cdots &amp; 0 &amp; 0 &amp; \cdots &amp; 0 \\
0 &amp; 0 &amp; 1 &amp; 0 &amp; \cdots &amp; 0 &amp; 0 &amp; \cdots &amp; 0 \\
0 &amp; 0 &amp; 0 &amp; 0 &amp; \cdots &amp; 1 &amp; 0 &amp; \cdots &amp; 0 \\
0 &amp; 0 &amp; 0 &amp; 0 &amp; \cdots &amp; 0 &amp; 1 &amp; \cdots &amp; 0 \\
\end{bmatrix}, \
F_{x,j} \in \mathbb{R}^{5\times (3+2n)}\).</p>

<p>The non-zeros columns are at \(2j+2\) and \(2j+3\).</p>

<p>Now we can obtained the EKF algorithm for SLAM problem below by changing the motion function, observation function and the corresponding Jacobian in EKF for localization.</p>

<div class="row justify-content-center">
    <div class="col">
        <div class="w-75 mx-auto" style="background-color: white;">
            <img class="img-fluid" src="/projects/SLAM/EKF-slam/assets/img/EKF-slam.png" alt="" />
        </div>
    </div>
</div>
<div class="caption">
The Extended Kalman Filter for SLAM
</div>
<p><br /></p>

<h2 id="code-explanation">Code Explanation</h2>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">[mu, sigma] = prediction_step(mu, sigma, u)</code>: Update the belief of the robotâ€™s pose based on the motion model. Implement line 1 to 4 in EKF SLAM Algorithm.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">[mu, sigma, observedLandmarks] = correction_step(mu, sigma, z, observedLandmarks)</code>: Updates the belief of the robotâ€™s pose and landmark positions according to the sensor model. Implement line 6 to 19 in EKF SLAM Algorithm.</p>
  </li>
</ol>

<h3 id="references">References</h3>

<ol>
  <li>
    <p><strong>Robot Mapping</strong><br />
University of Freiburg, WS 2013/14, <a href="http://ais.informatik.uni-freiburg.de/teaching/ws13/mapping/">http://ais.informatik.uni-freiburg.de/teaching/ws13/mapping/</a></p>
  </li>
  <li>
    <p><strong>Probabilistic Robotics</strong><br />
S. Thrun, W. Burgard, and D. Fox. MIT Press, Cambridge, Mass., (2005)</p>
  </li>
</ol>

  </article>

</div>

    </div>

    <!-- Footer -->

    
<footer class="sticky-bottom mt-5">
  <div class="container">
    &copy; Copyright 2021 Fan  Yang.
    
    
    
    Last updated: November 25, 2021.
    
  </div>
</footer>



  </body>

  <!-- Bootsrap & MDB scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.4.4/umd/popper.min.js" integrity="sha512-eUQ9hGdLjBjY3F41CScH3UX+4JDSI9zXeroz7hJ+RteoCaY+GP/LDoM8AO+Pt+DRFw3nXqsjh9Zsts8hnYv8/A==" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha512-M5KW3ztuIICmVIhjSqXe01oV2bpe248gOxqmlcYrEzAvws7Pw3z6BK0iGbrwvdrUQUhi3eXgtxp5I8PDo9YfjQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js" integrity="sha512-Mug9KHKmroQFMLm93zGrjhibM2z2Obg9l6qFG2qKjXEXkMp/VDkI4uju9m4QKPjWSwQ6O2qzZEnJDEeCw0Blcw==" crossorigin="anonymous"></script>

  
<!-- Mansory & imagesLoaded -->
<script defer src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script defer src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
<script defer src="/assets/js/mansory.js" type="text/javascript"></script>


  


<!-- Load Common JS -->
<script src="/assets/js/common.js"></script>


</html>
