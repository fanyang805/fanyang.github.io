<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Fan's site | Extended Kalman Filter for Localization</title>
<meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design.
">

<!-- Open Graph -->


<!-- Bootstrap & MDB -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" integrity="sha512-RO38pBRxYH3SoOprtPTD86JFOclM51/XTIdEPh5j8sj4tp8jmQIx26twG52UaLi//hQldfrh7e51WzP9wuP32Q==" crossorigin="anonymous" />

<!-- Fonts & Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"  integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.0/css/academicons.min.css" integrity="sha512-W4yqoT1+8NLkinBLBZko+dFB2ZbHsYLDdr50VElllRcNt2Q4/GSs6u71UHKxB7S6JEMCp5Ve4xjh3eGQl/HRvg==" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

<!-- Code Syntax Highlighting -->
<link rel="stylesheet" href="https://gitcdn.link/repo/jwarby/jekyll-pygments-themes/master/github.css" />

<!-- Styles -->
<!-- 
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22></text></svg>">
 -->
<!-- <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22></text></svg>"> -->
<link rel="shortcut icon" href="/assets/img/favicon.ico">
<link rel="stylesheet" href="/assets/css/main.css">

<link rel="canonical" href="/projects/localization/extended-kalman-filter/">

<!-- JQuery -->
<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>


<!-- Theming-->

  <script src="/assets/js/theme.js"></script>
  <!-- Load DarkMode JS -->
<script src="/assets/js/dark_mode.js"></script>






    
<!-- MathJax -->
<script type="text/javascript">
  window.MathJax = {
    tex: {
      tags: 'ams'
    }
  };
</script>
<script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js"></script>
<script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>


  </head>

  <body class="fixed-top-nav sticky-bottom-footer">

    <!-- Header -->

    <header>

    <!-- Nav Bar -->
    <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
    <div class="container">
      
      <a class="navbar-brand title font-weight-lighter" href="/">
        <i class="fas fa-fan fa-spin"></i>
       Fan's site
      </a>
      
      <!-- Navbar Toggle -->
      <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar top-bar"></span>
        <span class="icon-bar middle-bar"></span>
        <span class="icon-bar bottom-bar"></span>
      </button>
      <div class="collapse navbar-collapse text-right" id="navbarNav">
        <ul class="navbar-nav ml-auto flex-nowrap">
          <!-- About -->
          <li class="nav-item ">
            <a class="nav-link" href="/">
              About
              
            </a>
          </li>
          
          <!-- Blog -->
          <li class="nav-item ">
            <a class="nav-link" href="/blog/">
              Blog 
              
            </a>
          </li>
          
          <!-- Other pages -->
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/course-work/">
                Course Work
                
              </a>
          </li>
          
          
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/projects/">
                Projects
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/publications/">
                Publications
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/research/">
                Research
                
              </a>
          </li>
          
          
          
          <li class="nav-item ">
              <a class="nav-link" href="/services/">
                Services
                
              </a>
          </li>
          
          
          
          
          
            <div class = "toggle-container">
              <a id = "light-toggle">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
              </a>
            </div>
          
        </ul>
      </div>
    </div>
  </nav>

</header>


    <!-- Content -->

    <div class="container mt-5">
      <div class="post">

  <header class="post-header">
    <h1 class="post-title">Extended Kalman Filter for Localization</h1>
    <!-- <p class="post-description">Extended Kalman Filter is an extension of the Kalman Filter which deals with the nonlinearities in the motion and observation model.This project implement a complete extended Kalman Filter using Python.
</p> -->
  </header>

  <article>
    <p>The Kalman filter is a technique for filtering and prediction in linear Gaussian systems. It is assumed that</p>

<ol>
  <li>
    <p>The initial belief 
\(bel(x_0)\) is normally distributed.</p>
  </li>
  <li>
    <p>The motion model 
\(P(x_t|x_{t-1}, u_t)\) is a linear function with additional Gaussian noise, i.e.,</p>

\[\begin{equation}\label{motion}
     x_t = A_t x_{t-1} + B_t u_t + \epsilon_t
 \end{equation}\]
  </li>
  <li>
    <p>The observation model 
\(P(z_t|x_t)\) is linear with Gaussian noise.</p>

\[\begin{equation}\label{observation}
     z_t = C_t x_{t} + \delta_t
 \end{equation}\]
  </li>
</ol>

<p>These assumptions are crucial for the correctness of the KF. The efficiency of KF is due to the fact that any linear transformation of a Gaussian random variable results in another Gussian random variable which can be computed in closed form.</p>

<p>However, in most robotics system, the motion model and observation model are nonlinear. To deal with the nonlinearity, the Extended Kalman Filter linearizes the nonlinear function by the first order Taylor expansion and computes a Gussian approximation to the true belief.</p>

<p>In this project, I implemented the EKF in Python. Given the ground-true position of the landmark, sensor readings and odometry data<sup>[1]</sup>, at each time step the robot estimate the current pose parameterized by mean and covariance of a Gaussian distribution. The belief is visualized by the arrow indicating the mean pose and covariance ellipse.</p>
<div class="row justify-content-center">
      <div class="col">
        <div class="w-50 mx-auto" style="background-color: white;">
            <img class="img-fluid" src="/projects/localization/EKF/assets/img/kalman_filter.gif" alt="" />
        </div>
      </div>
  </div>
<div class="caption">
  Extended Kalman Filter
  </div>

<h2 id="ekf-overview">EKF Overview</h2>

<p>The extended Kalman Filter relaxes one of the assumptions, the linearity assumption. More specifically, the matrix \(A_t\), \(B_t\) in motion model Eq.\(~\eqref{motion}\) and \(C_t\) in observation model Eq.\(~\eqref{observation}\) are now replaced by nonlinear function \(g\) and \(h\).</p>

\[\begin{equation*}
\begin{split}
x_t &amp;= g(u_t, x_{t-1}) + \epsilon_t \\
z_t &amp;= h(x_t) + \delta_t
\end{split}
\end{equation*}\]

<p>The nonlinear functions are approximated by linear functions using first-order Taylor explansion, i.e.,</p>

\[g(u_t,x_{t-1}) \approx g(u_t, \mu_{t-1}) + \frac{\partial g(u_t, x_{t-1})}{x_{t-1}}|_{x_{t-1}=\mu_{t-1}}(x_{t-1} - \mu_{t-1})\]

<p>where \(\mu_{t-1}\) is the mean of the posterior of previous time step \(x_{t-1}\). Let
\(G_t := \frac{\partial g(u_t, x_{t-1})}{x_{t-1}}|_{x_{t-1}=\mu_{t-1}}\), which is the Jacobian matrix.</p>

<p>Similar to the observation model:</p>

\[h(x_t) \approx h(\bar{\mu}_t) + H_t (x_t - \bar{\mu}_t)\]

<p>where \(\bar{\mu}_t\) is the mean of the predicted posterior and \(H_t\) is the Jacobian of \(h(x_t)\) with respect to \(x_t\) at \(\bar{\mu}_{t}\), i.e.,</p>

\[H_t = \frac{\partial h(x_t)}{\partial x_t}|_{x_t = \bar{\mu}_t}\]

<p>The EKF basically replace the linear prediction by the nonlinear generalizations in EKF. In particular, the linear system matrices \(A_t\) and \(B_t\) are replaced by \(G_t\) and \(C_t\) is replaced by \(H_t\). The detailed algorithm<sup>[2]</sup> is presented below.</p>

<div class="row justify-content-center">
    <div class="col">
        <div class="w-50 mx-auto" style="background-color: white;">
            <img class="img-fluid" src="/projects/localization/EKF/assets/img/extended-kalman-filter.png" alt="" />
        </div>
    </div>
</div>
<div class="caption">
The extended Kalman Filter
</div>
<p><br /></p>

<h2 id="code-explanation">Code Explanation</h2>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">prediction_step(odometry, mu, sigma)</code>: given the odometry and the estimate of the previous pose, motion noise, return the predicted pose in the current time step using the Jacobian of the noise-free odometry motion model.</p>

\[G_t = 
 \begin{bmatrix}
     1 &amp; 0 &amp; -\delta_{tran} \sin(\mu_{\theta_{t-1}}+\delta_{rot1}) \\
     0 &amp; 1 &amp; \delta_{tran} \cos(\mu_{\theta_{t-1}}+\delta_{rot1})  \\
     0 &amp; 0 &amp; 1 
 \end{bmatrix}\]

    <p>where \(\mu_{\theta_{t-1}}\) is the mean of the estimated orientation of the previous time step.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">correction_step(sensor_data, mu, sigma, landmarks)</code>: given the sensor readings, the ground-truth position of the landmarks and the predicated pose of current time step, return the corrected pose using Jacobian \(H_t\).</p>

\[H_t = 
 \begin{bmatrix}
     \frac{\mu_{x_t} - \ell_x^{(k)}}{f(\mu_t, \ell^{(1)})} &amp; \frac{\mu_{y_t} - \ell_y^{(1)}}{f(\mu_t, \ell^{(1)})} &amp; 0 \\
     \frac{\mu_{x_t} - \ell_x^{(k)}}{f(\mu_t, \ell^{(2)})} &amp; \frac{\mu_{y_t} - \ell_y^{(2)}}{f(\mu_t, \ell^{(2)})} &amp; 0 \\
     \vdots &amp; \vdots &amp; \vdots  \\
     \frac{\mu_{x_t} - \ell_x^{(k)}}{f(\mu_t, \ell^{(k)})} &amp; \frac{\mu_{y_t} - \ell_y^{(k)}}{f(\mu_t, \ell^{(k)})} &amp; 0 \\
 \end{bmatrix}\]

    <p>where \(k\) is number of the sensors, \(\ell^{(i)} = (\ell_x^{(i)}, \ell_y^{(i)})^{T}\) is the position of the landmark, \(\mu_t = (\mu_{x_t}, \mu_{y_t}, \mu_{\theta_t})^T\) is the mean of the predicated pose \(\bar{x}_t\) obtained from the prediction step. Further \(f(\mu_t, \ell^{(i)})\) returns the expected distance to the landmark \(i\)</p>

\[f(\mu_t, \ell^{(i)}) = \sqrt{(\mu_{x_t} - \ell_x^{(i)})^2 + (\mu_{y_t} - \ell_y^{(i)})^2}\]
  </li>
</ol>

<h3 id="references">References</h3>

<ol>
  <li>
    <p><strong>Introduction to Mobile Robotics</strong><br />
University of Freiburg, Spring, 2020, <a href="http://ais.informatik.uni-freiburg.de/teaching/ss20/robotics/index_en.php">http://ais.informatik.uni-freiburg.de/teaching/ss20/robotics/index_en.php</a></p>
  </li>
  <li>
    <p><strong>Probabilistic Robotics</strong><br />
S. Thrun, W. Burgard, and D. Fox. MIT Press, Cambridge, Mass., (2005)</p>
  </li>
</ol>

  </article>

</div>

    </div>

    <!-- Footer -->

    
<footer class="sticky-bottom mt-5">
  <div class="container">
    &copy; Copyright 2021 Fan  Yang.
    
    
    
    Last updated: November 25, 2021.
    
  </div>
</footer>



  </body>

  <!-- Bootsrap & MDB scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.4.4/umd/popper.min.js" integrity="sha512-eUQ9hGdLjBjY3F41CScH3UX+4JDSI9zXeroz7hJ+RteoCaY+GP/LDoM8AO+Pt+DRFw3nXqsjh9Zsts8hnYv8/A==" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha512-M5KW3ztuIICmVIhjSqXe01oV2bpe248gOxqmlcYrEzAvws7Pw3z6BK0iGbrwvdrUQUhi3eXgtxp5I8PDo9YfjQ==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js" integrity="sha512-Mug9KHKmroQFMLm93zGrjhibM2z2Obg9l6qFG2qKjXEXkMp/VDkI4uju9m4QKPjWSwQ6O2qzZEnJDEeCw0Blcw==" crossorigin="anonymous"></script>

  
<!-- Mansory & imagesLoaded -->
<script defer src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script defer src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
<script defer src="/assets/js/mansory.js" type="text/javascript"></script>


  


<!-- Load Common JS -->
<script src="/assets/js/common.js"></script>


</html>
